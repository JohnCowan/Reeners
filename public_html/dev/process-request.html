<?php
require_once('includes/myUtils.php');
$params = array(
				'title' => 'Application Request, The Suites, Student Housing, Cortland, NY',
				'description' => 'Request an Application for leasing a suite in The Suites owned by CornerStone Properties of Cortland',
				'keywords' => 'student housing, student, housing, apartments, rentals,'
				);

printHeaders($params);
logHits("process-request");

?>

<div id="mainbody">

<?php
foreach( array('first_name', 'mid_name',  'last_name', 'addr1', 'addr2', 'city', 'state', 'country',              'zip', 'home_phone', 'cell_phone', 'email', 'dob', 'cs_address', 'semyear', 'location',         'comments', 'tennant2', 'tennant3', 'tennant2_email', 'tennant3_email')as $v){
	$$v = !empty($_REQUEST[$v])? $_REQUEST[$v]:'';
}

if( isset($_REQUEST['action']) && $_REQUEST['action'] == 'Submit' ){

    $fields = array('first_name' => 'First Name', 
		    'mid_name'   => 'Middle Name',
		    'last_name'  => 'Last Name',
		    'addr1'      => 'Street Address',
		    'addr2'      => 'Street Address 2',
		    'city'       => 'City',
		    'state'      => 'State',
		    'zip'        => 'Zip',
		    'country'    => 'Country',
		    'home_phone' => 'Home Phone',
		    'cell_phone' => 'Cell Phone',
		    'email'      => 'Email',
		    'dob'        => 'Date of Birth',
			'cs_address' => 'Current Cortland State Address',
			'cs_landlord' => 'Current Cortland Landlord',
		    'semyear'    => 'Semester / Year',
			'tennant2'   =>  'Tennant 2 Name',
			'tennant2_email' => 'Tennant 2 Email',
			'tennant3'   =>  'Tennant 3 Name',
			'tennant3_email' => 'Tennant 3 Email'
);

	$required = array('first_name' => $first_name,
					  'last_name'  => $last_name,
					  'addr1'      => $addr1,
					  'city'       => $city,
					  'state'      => $state,
					  'zip'        => $zip,
					  'country'    => $country,
					  'dob'        => $dob,
					  'email'      => $email,
					  'semyear'    => $semyear);

    $lengths = array('first_name' => 25,
					 'mid_name'   => 25,
					 'last_name'  => 25,
					 'addr1'      => 50,
					 'addr2'      => 50,
					 'city'       => 25,
					 'state'      => 25,
					 'zip'        => 10,
					 'country'    => 50,
					 'home_phone' => 15,
					 'cell_phone' => 15,
					 'email'      => 50,
					 'dob'        => 10,
					 'cs_address' => 75,
					 'semyear'    => 15,
                     'tennant2'   => 50,
                     'tennant2_email' => 50,
                     'tennant3'   => 50,
                     'tennant3_email' => 50,
);

    $errors = false;

    $labels = array();
	foreach ( $required as $key => $val ){
		if( !$val ){
            $errors = true;
			$labels[$key] = "style='color: #b31b1b;'";
            #$requiredErrorMsg .= "<li>$fields[$key] is requried</li>";
        }
    }
	$dobErrorMsg = '';
    if( !preg_match('/\/|-/', $_REQUEST['dob']) ){
		$errors = true;
        $labels['dob'] = "style='color: #b31b1b;'";
        #$dobErrorMsg = '<p style="color: b31b1b;">Your Date of Birth must be in the format of mm/dd/yyyy</p>';
    }
    
	$length_error_message = '';
    foreach ( $lengths as $key => $val ){
        if( strlen($val) > $lengths[$key] ){
			$errors = true;
            $err_len = strlen($val);
            $length_error_message .= "<li>$fields[$key] cannot exceed $lengths[$key] characters
                                    in length.</li>";
        }
    }
    if( strlen($length_error_message) ){
		print '<p style="color: b31b1b;">There are problems with the length of one or more of your entries.  
                  Please correct the following:</p>
                  <ul style="color: b31b1b;">';
        
        print "</ul>";
    }
  
	$successful_entry = true;
    if( !$errors ){
        # do an insert
        if( $_REQUEST['dob'] ){
            if( preg_match('/\//', $_REQUEST['dob']) ){
				list($m,$d,$y) = explode('/',$_REQUEST['dob']);			
            }
            if( preg_match('/-/', $_REQUEST['dob']) ){
				list($m,$d,$y) = explode('/-/',$_REQUEST['dob']);		
            }
            if( strlen($y) == 2 ){
				$y = '19'.$y;  # make year 4 digits.
			}
        }
        
        $dob = "$y-$m-$d"; 

        $entry_date = date('Y-m-d',time());
        $sql = "insert into applicants
                     (first_name, mid_name, last_name, addr1, addr2,
                      city, state, zip, country, home_phone, cell_phone,
                      email, dob, cs_address, semyear, entry_date, comments,
                      tennant2, tennant2_email, tennant3, tennant3_email,location, cs_landlord)
                values
                     (?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?,?,?, ?,?,?)";
        $myParams = array($first_name, $mid_name, $last_name, $addr1, $addr2,
                      $city, $state, $zip, $country, $home_phone, $cell_phone,
                      $email, $dob, $cs_address, $semyear, $entry_date, $comments,
                      $tennant2, $tennant2_email, $tennant3, $tennant3_email, $location,$cs_landlord);
        $results = $globalMySqlConnect->query($sql, $myParams);
        if( DB::isError($results) ){
			errorEmail(array('process-request.html',
											 $results->getMessage(),
                       $results->toString()) );

            die($results->getMessage()." ".$results->toString());
			$successful_entry = false;
        }
        if( $globalMySqlConnect->affectedRows()== 1 ){
            ?>
             <p>Thank you for your interest in The Suites for you student housing needs, and for completing our online Request an Application form.  
             <br />Your request has been recorded and an email sent to CornerStone Properties of Cortland.</p>
            <?php
            $successful_entry = true;
        }else{
            print "<p>Sorry, we were not able to record your information. Please try again.</p>";
            $successful_entry = false;
        }
    }else{
        print "<p style class=\"red\">There were errors with your form entry.  Problem areas are marked with RED text on the form below.</p>";
        $successful_entry = false;
        print $dobErrorMsg;
        print $length_error_message;
        print $requiredErrorMsg;
    }

    if( $successful_entry == true ){
		# send email to mike and jim
        $to      = "info@cortlandcollegehousing.com";
        #$to = 'john@johndcowan.com';
        $from    = "info@cortlandcollegehousing.com";
        $cc      = "john@johndcowan.com";
        $subject = "The Suites Online Application form";

        $headers  = "To: Mike Reeners: <$to>\r\n";
        $headers .= "CC: Webmaster: <$cc>\r\n";
		$headers .= "From: 'Online Application Form' <$from>\r\n";
		$headers .= "Reply-To: 'CornerStone Properties' <$from>\r\n";
		$headers .= "Return-Path: $from\r\n";

		$today = date('m/d/Y', time());
$message  = <<<EOD
	 The following information was completed on the Online Application Form for The Suites Apartments.
	 Date: $today
	 
         Name: $first_name $mid_nam $last_name
         Address: $addr1
                  $addr2
                  $city
                  $state
                  $country
                  $zip

         Home Phone: $home_phone
         Cell Phone: $cell_phone
         E-mail:     $email

	 Date of Birth: $dob

		Current Cortland Address: $cs_address
		Current Cortland Landlord: $cs_landlord

         Semester Year Needed:
           $semyear
		 Location Requested:
           $location
         
		The Other Two Tennants:
        Tennant 2 Name: $tennant2
        Tennant 2 Email: $tennant2_email

        Tennant 3 Name: $tennant3
        Tennant 3 Email: $tennant3_email

        Comments: 
           $comments
EOD;
		
      if( mail($to, $subject, $message, $headers)){
         # all is well.
      }else{
        # code here to send email to webman
      }
    }

}

if( $errors ){

?>

<p>
<?php printHeader("The Suites") ?>
</p>
<p>
If you are interested in leasing one of our suites for an upcomming semester, please complete the Request an Application form below and submit it.  Doing this will not reserve a suite in your name.  We will add your name to our list of students interested in reserving a suite.  We will also mail you an application form which you will need to complete and return to us. 
</p>
<p>Your information will be kept private and confidential.  We will never give away your information to anyone at anytime.</p>

<style type="text/css">
th { text-align: left; }
 .red { color: #b31b1b; }
</style>
	  <p>* denotes required fields:</p>
<form action=<?php print $_SERVER['PHP_SELF'] ?> method="post">

<table>
<tr>
<td <?php print $labels['first_name'] ?>>* First Name</td>
<td><input type="text" name="first_name" maxLength="30" size="20" value="<?php print $first_name ?>"></td>
</tr>
<tr>
<td <?php print $labels['mid_name'] ?>>Middle Name or Init</td>
<td><input type="text" name="mid_name" maxLength="30" size="20" value="<?php print $mid_name ?>"></td>
</tr>
<tr>
<td <?php print $labels['last_name'] ?>>* Last Name</td>
<td><input type="text" name="last_name" maxLength="30" size="20" value="<?php print $last_name ?>"></td>
</tr>
<tr>
<td <?php print $labels['addr1'] ?>>* Home Address 1</td>
<td><input type="text" name="addr1" maxLength="30" size="20" value="<?php print $addr1 ?>"></td>
</tr>
<tr>
<td <?php print $labels['addr2'] ?>>Home Address 2</td>
<td><input type="text" name="addr2" maxLength="30" size="20" value="<?php print $addr2 ?>"></td>
</tr>
<tr>
<td <?php print $labels['city'] ?>>* City</td>
<td><input type="text" name="city" maxLength="30" size="20" value="<?php print $city ?>"></td>
</tr>
<tr>
<td <?php print $labels['state'] ?>>* State</td>
<td><input type="text" name="state" maxLength="30" size="20" value="<?php print $state ?>"></td>
</tr>
<tr>
<td <?php print $labels['zip'] ?>>* Zip Code</td>
<td><input type="text" name="zip" maxLength="30" size="20" value="<?php print $zip ?>"></td>
</tr>
<tr>
<td <?php print $labels['country'] ?>>* Country</td>
<td><input type="text" name="country" maxLength="30" size="20" value="<?php print $country ?>"></td>
</tr>
<tr>
<td <?php print $labels['home_phone'] ?>>Home Phone</td>
<td><input type="text" name="home_phone" maxLength="30" size="20" value="<?php print $home_phone ?>"></td>
</tr>
<tr>
<td <?php print $labels['cell_phone'] ?>>Cell Phone</td>
<td><input type="text" name="cell_phone" maxLength="30" size="20" value="<?php print $cell_phone ?>"></td>
</tr>
<tr>
<td <?php print $labels['email'] ?>>* Email</td>
<td><input type="text" name="email" maxLength="30" size="20" value="<?php print $email ?>"></td>
</tr>
<tr>
<td <?php print $labels['dob'] ?>>* Date of Birth</td>
<td><input type="text" name="dob" maxLength="30" size="20" value="<?php print $dob ?>"> <span class="red">as(mm/dd/yyyy)</td>
</tr>
<tr>
<td <?php print $labels['cs_address'] ?>>Current Cortland Address</td>
	  <td><input type="text" name="cs_address" maxLength="75" size="30" value="<?php print $cs_address ?>"> <span style="font-size: .9em;">(if current student)</span></td>
</tr>

<tr>
   <td <?php print $labels['cs_landlord'] ?>>Current Landlord</td>
   <td><input type="text" name="cs_landlord" id="cs_landlord" size="30" maxlength="75" value="<?php print $cs_landlord; ?>" /> <span style="font-size: .9em;">(if current student)</span> Name and address please.</td>
</tr>

<tr>
<td <?php print $labels['semyear'] ?>>* Apartment Needed <br />
    Semester/Year?</td>
  <?php
$curYr = date('Y', time());
$curYr = 2008;
  ?>
<td>
<select name="semyear">
  <option value=""></option>
  <option value="fall-2009"   <?php if($semyear == 'fall-2009'){ print 'selected="selected"'; } ?>>Fall 2009</option>
  <option value="spring-2009" <?php if($semyear == 'spring-2010'){ print 'selected="selected"'; } ?>>Spring 2010</option>
  <option value="spring-2009" <?php if($semyear == 'fall-2010'){ print 'selected="selected"'; } ?>>Fall 2010</option>
</td>
</tr>


<tr>
  <td>Location Requested</td>
  <td>
   <select name="location">
    <?php
    $gselected = '';
    $tselected = '';
	if( !empty($location) && $location=='Groton Ave' ){
      $gselected = 'selected="selected"';
      $tselected = '';
    }
	if( !empty($location) && $location=='Tompkins Ave' ){
      $tselected = 'selected="selected"';
      $gselected = '';
    }
    ?>
     <option value="Groton Ave" <?php print $gselected; ?>>Groton Ave</option>
    <option value="Tompkins Ave" <?php print $tselected; ?>>Tompkins Ave</option>
   </select>
  </td>
</tr>


<tr>
  <td colspan="2">Please list the Names and Emails of the two people who are interested in leasing an apartment with you</td>
</tr>
<tr>
  <td <?php print $labels['tennant2'] ?>>2nd Tennant Name:</td><td><input type="text" name="tennant2" size="20" /></td>
</tr>
<tr>
  <td <?php print $labels['tennant2_email'] ?>>2nd Tennant Email:</td><td><input type="text" name="tennant2_email" size="20" /></td>
</tr>
<tr>
  <td <?php print $labels['tennant3'] ?>>3rd Tennant Name:</td><td><input type="text" name="tennant3" size="20" /></td>
</tr>
<tr>
  <td <?php print $labels['tennant3_email'] ?>>3rd Tennant Email:</td><td><input type="text" name="tennant3_email" size="20" /></td>
</tr>



<tr>
<td>Additional Comments</td>
<td><textarea name="comments" cols="40" rows="10" value="<?php print $comments ?>"></textarea>

<tr>
<td><input type="submit" value="Submit" name="action"></td></tr>
</table>

</form>

</div>
<?php } ?>

<?php printFooter(); ?>
